---
title: "Understanding p-values and assumptions behind statistical tests"
author: "Cyril Matthey-Doret"
date: "December 8, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
library(ggplot2); library(gridExtra)

```

#Introduction

The goal of this report is to assess how violating assumptions of statistical tests can affect the outcome.

# Example 1: Impact of correlation between datasets on two-sample t-test

Here, I investigate how dependence between two datasets (Figure 1) can impact the results of a two-sample (non-paired) t-test using simulated data. For each simulation, I generate 2 normally distributed datasets with the same mean and standard deviation. When the two datasets are independent, we obtain uniformely distributed p-values between 0 and 1, as should be the case when the distributions are similar. I will look at how dependence between similar samples affects the distribution of p-values.

To observe the effect of dependence between datasets (or paired data), I generate pairs of datasets with different degrees of correlation using Cholesky decomposition\footnote{Dependency of variable $Y$ on variable $X$ is induced by applying $Y_d = r*X+\sqrt{1-r^2}*Y$ where $r$ is the desired correlation coefficient and $Y_d$ is the dependent $Y$ variable.}. For every simulation, a new pair of dataset is generated and a two-sample t-test is performed. The p-values are stored and the proportion of p-values below 0.05 is measured at different correlation coefficients.

```{r pairs_simulation, echo=T, eval=T}
r.coef <- -1
n<-1000
mycol <- heat.colors(40,alpha=0.3)
pvalues_np <- data.frame(rep(NA,n))
pvalues_p <- data.frame(rep(NA,n))
colnames(pvalues_np)=colnames(pvalues_p) <- "-1"
c <- 1
for(r in round(seq(-0.95,1,0.05),2)){pvalues_np[,as.character(r)]<-rep(NA,n)}
for(r in round(seq(-0.95,1,0.05),2)){pvalues_p[,as.character(r)]<-rep(NA,n)}

while(r.coef<=1){
  for(sim in 1:n){
    X <- rnorm(mean = 0,100)
    Y <- rnorm(mean=0,100)
    Z <- r.coef*X+sqrt(1-r.coef^2)*Y
    pvalues_np[sim,c] <- t.test(X,Z,paired = F)$p.val
    pvalues_p[sim,c] <- t.test(X,Z,paired = T)$p.val
  }
  r.coef <- r.coef + 0.05
  c <- c+1
}
prop_np <- rep(NA,41)
for(p in 1:length(colnames(pvalues_np))){
  prop_np[p]<-sum(pvalues_np[,p]<0.05)/length(pvalues_np[,p])
}
prop_p <- rep(NA,41)
for(p in 1:length(colnames(pvalues_p))){
  prop_p[p]<-sum(pvalues_p[,p]<0.05)/length(pvalues_p[,p])
}
```

When using the two-sample t-test, the proportion of false positive is dependent on the coefficient of correlation (Figure 2) between the 2 samples. Negative correlation increasee the proportion of false positives while positive correlation decreases it. Therefore, if the paired datasets have a positive correlation, the test will be biased towards conservative results, whereas if they are negatively correlated, it will be biased in a liberal way. 

#Figures:

```{r vizu_pair, echo=F, fig.height=6, fig.cap="Illustration of two simulated datasets X and Y where varying levels of dependence of Y on X are generated. Top: $\\rho$ denotes the correlation coefficient between X and Y. The colour scale allows to visualize displacement of points as the correlation is increased by incrementing $\\rho$ of 0.05. Bottom:  Same datasets, represented only with $\\rho$=0 (blue) and $\\rho$=1 (green)."}
r.coef <- 0
X <- rnorm(mean = 0,100)
Y <- rnorm(mean=0,100)
mycol <- heat.colors(25,alpha=0.8)
c <- 1
corplot <- ggplot()+geom_point(aes(x=X,y=Y))+scale_colour_gradient(low=mycol[1],high=mycol[20],limits=c(0,1),guide = "colourbar",name=expression(rho))+ggtitle("Inducing dependence between two datasets")+theme_bw()
while(r.coef<=1){
  Z <- r.coef*X+sqrt(1-r.coef^2)*Y
  corplot <- corplot + geom_point(aes_string(x=X,y=Z),colour=mycol[c])
  r.coef <- r.coef + 0.05
  c <- c+1
}
extremplot <- ggplot()+geom_point(aes(x=X,y=Y),col=alpha("blue",1),pch=5)+geom_point(aes(x=X,y=Z),col=(alpha("green",1)), pch=5)+theme_bw()
grid.arrange(corplot, extremplot, ncol=1)
```

```{r effect_dep, echo=F, fig.cap="Proportion of false positive across 10,000 simulations at different correlation coefficients between datasets. Proportion of p-values below 0.05 when comparing two samples with equal mean and standard deviations at different degrees of correlation using A. two-sample t-tests and B. paired two-sample t-tests"}

par(mfrow=c(2,1))
barplot(prop_np, names= seq(-1,1,0.05),col=cm.colors(41), main="A. Two-sample t-test", xlab=expression(rho), ylab="prop. p<0.05")
abline(h=0.05, lty=2)
barplot(prop_p, names= seq(-1,1,0.05), col=cm.colors(41), main="B. Paired two-sample t-test", xlab=expression(rho), ylab="prop. p<0.05")
abline(h=0.05, lty=2)
```